name: CD Pipeline

on:
  workflow_run:
    workflows: ["CI Pipeline"]
    types:
      - completed
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up kubectl
        uses: azure/setup-kubectl@v3
        with:
          version: "v1.27.0"

      - name: Configure kubeconfig from secret
        run: |
          mkdir -p $HOME/.kube
          echo "${{ secrets.KUBE_CONFIG }}" | base64 --decode > $HOME/.kube/config
          chmod 600 $HOME/.kube/config

      - name: Verify Cluster
        run: kubectl get nodes

      - name: Create k8s secret for app (from GitHub Secrets)
        run: |
          kubectl create secret generic task-backend-secrets \
            --from-literal=MONGO_DB_URL="${{ secrets.MONGO_DB_URL }}" \
            --from-literal=JWT_SECRET="${{ secrets.JWT_SECRET }}" \
            --from-literal=PORT="3000" \
            --dry-run=client -o yaml | kubectl apply -f -

      - name: Docker login
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKER_USERNAME }}
          password: ${{ secrets.DOCKER_PASSWORD }}

      - name: Pull Docker image
        run: docker pull ${{ secrets.DOCKER_USERNAME }}/task-backend:latest

      - name: Deploy to Kubernetes (apply manifests)
        run: |
          kubectl apply -f k8s/deployment.yml
          kubectl apply -f k8s/service.yml
          kubectl rollout status deployment/task-backend --timeout=120s

      - name: Wait for pod ready
        run: |
          kubectl wait --for=condition=ready pod -l app=task-backend --timeout=120s

      - name: Dummy DAST Check (exec curl inside pod)
        run: |
          POD_NAME=$(kubectl get pods -l app=task-backend -o jsonpath="{.items[0].metadata.name}")
          echo "Running dummy security scan on pod $POD_NAME..."
          kubectl exec "$POD_NAME" -- curl -sSf http://localhost:3000/ || echo "Dummy DAST complete"
